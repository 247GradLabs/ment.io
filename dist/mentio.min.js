"use strict";angular.module("mentio",[]).directive("mentioMenu",function(e){return{restrict:"E",require:"ngModel",scope:{bind:"&",atVar:"=ngModel",macros:"="},controller:function(t,n,i){this.addRule=function(e){t.map[e.triggerChar]=e,t.triggerCharSet.push(e.triggerChar),void 0===this.triggerCharSet&&(this.triggerCharSet=[]),this.triggerCharSet.push(e.triggerChar)},t.query=function(e){var n=t.map[e];n.showMenu();var i=n.search({term:t.atVar});i&&i.hasOwnProperty("then")&&i.then(function(e){n.items=e}),n.atVar=t.atVar},this.replaceText=t.replaceText=function(n,i){var o=t.map[n],r=o.select({item:i});e.replaceAtMentionText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.triggerCharSet,r),t.atVar=""},t.hideAll=function(){for(var e in t.map)t.map.hasOwnProperty(e)&&t.map[e].hideMenu()},t.selectActive=function(){for(var e in t.map)t.map.hasOwnProperty(e)&&(t.map[e].hide||t.map[e].selectActive())},t.replaceMacro=function(i){var o=n(function(){e.replaceMacroText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.macros,t.macros[i])},300);t.$on("$destroy",function(){n.cancel(o)})},i.on("click",function(){t.$apply(function(){t.selectActive()})}),i.on("keydown keypress",function(){9===event.which&&t.$apply(function(){t.selectActive()})})},link:function(t){t.map={},t.triggerCharSet=[],t.$watch(function(e){return e.$eval(e.bind)},function(){var n=e.getAtMentionInfo(t.triggerCharSet);if(void 0!==n)t.targetElement=n.mentionSelectedElement,t.targetElementPath=n.mentionSelectedPath,t.targetElementSelectedOffset=n.mentionSelectedOffset,t.atVar=n.mentionText,t.query(n.mentionTriggerChar,n.mentionText);else{t.atVar="",t.hideAll();var i=e.getMacroMatch(t.macros);void 0!==i&&(t.targetElement=i.macroSelectedElement,t.targetElementPath=i.macroSelectedPath,t.targetElementSelectedOffset=i.macroSelectedOffset,t.replaceMacro(i.macroText))}})}}}).directive("mentioRule",function(e){function t(e,t){angular.element(t).bind("keydown keypress",function(t){e.hide||(27===t.which&&(e.$apply(function(){e.hide=!0}),t.preventDefault()),40===t.which&&(t.preventDefault(),e.$apply(function(){e.activateNextItem()})),38===t.which&&(t.preventDefault(),e.$apply(function(){e.activatePreviousItem()})),13===t.which&&(t.preventDefault(),e.$apply(function(){e.selectActive()})))})}return{restrict:"E",scope:{search:"&",select:"&",items:"="},require:"^mentioMenu",templateUrl:function(e,t){return t.template},controller:["$scope","$attrs",function(e,t){e.items=[],e.hide=!0,e.triggerChar=t.triggerChar,this.activate=e.activate=function(t){e.active=t},e.activateNextItem=function(){var t=e.items.indexOf(e.active);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.active);this.activate(e.items[0===t?e.items.length-1:t-1])},this.isActive=e.isActive=function(t){return e.active===t},e.selectActive=function(){e.selector(e.active)},this.selector=e.selector=function(t){e.hide=!0,e.controller.replaceText(e.triggerChar,t)},e.isVisible=function(){return!e.hide},e.showMenu=function(){e.requestVisiblePendingSearch=!0},e.hideMenu=function(){e.hide=!0}}],link:function(n,i,o,r){r.addRule(n),n.controller=r;var a=i;i[0].parentNode.removeChild(i[0]),document.body.appendChild(i[0]),t(n,document.body),n.$watch("items",function(e){e.length>0?(n.activate(e[0]),n.hide&&n.requestVisiblePendingSearch&&(n.hide=!1,n.requestVisiblePendingSearch=!1)):n.hide=!0}),n.$watch("isVisible()",function(t){t?e.popUnderMention(r.triggerCharSet,a):a.css("display","none")})}}}).directive("mentioMenuItem",function(){return{restrict:"A",scope:{mentioMenuItem:"="},require:"^mentioRule",link:function(e,t,n,i){var o=e.mentioMenuItem;e.$watch(function(){return i.isActive(o)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){i.activate(o)})}),t.bind("click",function(t){e.$apply(function(){i.selector(o)}),t.preventDefault()})}}}).filter("mentioHighlight",function(){function e(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(t,n){return n?(""+t).replace(new RegExp(e(n),"gi"),"<strong>$&</strong>"):t}}),angular.module("mentio").factory("mentioUtil",function(){function e(e,n){var i,o=s(e);void 0!==o?(i=t()?f(document.activeElement,o.mentionPosition):u(o.mentionPosition),n.css({top:i.top+"px",left:i.left+"px",position:"absolute",zIndex:100,display:"block"})):n.css({display:"none"})}function t(){var e=document.activeElement;if(null!==e){var t=e.nodeName;return"INPUT"===t||"TEXTAREA"===t}return!1}function n(e,t,n){for(var i,o=e,r=0;r<t.length;r++){if(o=o.childNodes[t[r]],void 0===o)return;for(;o.length<n;)n-=o.length,o=o.nextSibling}if(document.selection&&document.selection.createRange)i=document.selection.createRange().duplicate(),i.select(o),i.selectStartOffset(n),i.selectEndOffset(n),i.collapse(!0),document.selection.removeAllRanges(),document.selection.addRange(i);else if(window.getSelection){var a=window.getSelection();i=document.createRange(),i.setStart(o,n),i.setEnd(o,n),i.collapse(!0),a.removeAllRanges(),a.addRange(i),e.focus()}}function i(e,t,n){var i,o;if(document.selection&&document.selection.createRange)i=document.selection.createRange().duplicate(),i.selectStartOffset(t),i.selectEndOffset(n),i.collapse(!1),i.deleteContents(),i.pasteHTML(e);else if(window.getSelection){o=window.getSelection(),i=document.createRange(),i.setStart(o.anchorNode,t),i.setEnd(o.anchorNode,n),i.deleteContents();var r=document.createElement("div");r.innerHTML=e;for(var a,c,l=document.createDocumentFragment();a=r.firstChild;)c=l.appendChild(a);i.insertNode(l),c&&(i=i.cloneRange(),i.setStartAfter(c),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}}function o(e,t,i){var o=e.nodeName;"INPUT"===o||"TEXTAREA"===o?e!==document.activeElement&&e.focus():n(e,t,i)}function r(e,n,r,a,c){o(e,n,r);var s=l(a);if(void 0!==s)if(t()){var d=document.activeElement;if(document.selection){d.focus();var u=document.selection.createRange();u.selectStartOffset(s.macroPosition),u.selectEndOffset(s.macroPosition+s.macroText.length),u.text=c}else{var f=s.macroPosition,m=s.macroPosition+s.macroText.length;d.value=d.value.substring(0,f)+c+d.value.substring(m,d.value.length),d.selectionStart=f+c.length,d.selectionEnd=f+c.length}}else i(c,s.macroPosition,s.macroPosition+s.macroText.length)}function a(e,n,r,a,c){o(e,n,r);var l=s(a);if(void 0!==l)if(t()){var d=document.activeElement;if(document.selection){d.focus();var u=document.selection.createRange();u.selectStartOffset(l.mentionPosition),u.selectEndOffset(l.mentionPosition+l.mentionText.length),u.text=c}else{var f=l.mentionPosition,m=l.mentionPosition+l.mentionText.length+1;d.value=d.value.substring(0,f)+c+d.value.substring(m,d.value.length),d.selectionStart=f+c.length,d.selectionEnd=f+c.length}}else i(c,l.mentionPosition,l.mentionPosition+l.mentionText.length+1)}function c(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++){var n=e.parentNode.childNodes[t];if(n===e)return t}}function l(e){var n,i,o=[];if(t())n=document.activeElement;else{var r=window.getSelection();if(n=r.anchorNode,null!=n){for(var a,l=n.contentEditable;null!==n&&"true"!==l;)a=c(n),o.push(a),n=n.parentNode,null!==n&&(l=n.contentEditable);o.reverse(),i=r.getRangeAt(0).startOffset}}var s=d();if(void 0!==s&&null!==s){var u;if(angular.forEach(e,function(e,t){var r=s.toUpperCase().lastIndexOf(t.toUpperCase());if(r>=0&&t.length+r===s.length){var a=r-1;(0===r||" "===s.charAt(a)||" "===s.charAt(a))&&(u={macroPosition:r,macroText:t,macroSelectedElement:n,macroSelectedPath:o,macroSelectedOffset:i})}}),u)return u}}function s(e){var n,i,o=[];if(t())n=document.activeElement;else{var r=window.getSelection();if(n=r.anchorNode,null!=n){for(var a,l=n.contentEditable;null!==n&&"true"!==l;)a=c(n),o.push(a),n=n.parentNode,null!==n&&(l=n.contentEditable);o.reverse(),i=r.getRangeAt(0).startOffset}}var s=d();if(void 0!==s&&null!==s){var u,f=-1;if(e.forEach(function(e){var t=s.lastIndexOf(e);t>f&&(f=t,u=e)}),0===f||/[\xA0\s]/g.test(s.substring(f-1,f))){var m=s.substring(f+1,s.length);if(u=s.substring(f,f+1),!/[\xA0\s]/g.test(m))return{mentionPosition:f,mentionText:m,mentionSelectedElement:n,mentionSelectedPath:o,mentionSelectedOffset:i,mentionTriggerChar:u}}}}function d(){var e;if(t()){var n=document.activeElement;if(void 0!==document.selection){n.focus();var i=document.selection.createRange();e=i.text}else if(void 0!==n.selectionStart){var o=n.selectionStart;e=n.value.substring(0,o)}}else{var r=window.getSelection().anchorNode;if(null!=r){var a=r.textContent,c=window.getSelection().getRangeAt(0).startOffset;c>=0&&(e=a.substring(0,c))}}return e}function u(e){var t,n,i="﻿",o="&#xfeff;",r="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2);if(document.selection&&document.selection.createRange)n=document.selection.createRange().duplicate(),n.selectStartOffset(e),n.selectEndOffset(e),n.collapse(!1),n.pasteHTML('<span id="'+r+'" style="position: relative;">'+o+"</span>"),t=document.getElementById(r);else if(window.getSelection){var a=window.getSelection();n=document.createRange(),n.setStart(a.anchorNode,e),n.setEnd(a.anchorNode,e),n.collapse(!1),t=document.createElement("span"),t.id=r,t.appendChild(document.createTextNode(i)),n.insertNode(t)}var c=t,l={left:0,top:t.offsetHeight};do l.left+=c.offsetLeft,l.top+=c.offsetTop;while(c=c.offsetParent);return t.parentNode.removeChild(t),l}function f(e,t){var n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],i=null!==window.mozInnerScreenX,o=document.createElement("div");o.id="input-textarea-caret-position-mirror-div",document.body.appendChild(o);var r=o.style,a=window.getComputedStyle?getComputedStyle(e):e.currentStyle;r.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(r.wordWrap="break-word"),r.position="absolute",r.visibility="hidden",n.forEach(function(e){r[e]=a[e]}),i?(r.width=parseInt(a.width)-2+"px",e.scrollHeight>parseInt(a.height)&&(r.overflowY="scroll")):r.overflow="hidden",o.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(o.textContent=o.textContent.replace(/\s/g," "));var c=document.createElement("span");c.textContent=e.value.substring(t)||".",o.appendChild(c);var l={top:c.offsetTop+parseInt(a.borderTopWidth)+c.offsetHeight,left:c.offsetLeft+parseInt(a.borderLeftWidth)},s=e;do l.left+=s.offsetLeft,l.top+=s.offsetTop;while(s=s.offsetParent);return document.body.removeChild(o),l}return{popUnderMention:e,replaceMacroText:r,replaceAtMentionText:a,getMacroMatch:l,getAtMentionInfo:s}});
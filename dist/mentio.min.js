"use strict";angular.module("mentio",[]).directive("mentio",function(e,t,n,i){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",typedTerm:"=mentioTypedTerm",ngModel:"="},controller:function(t,n,r){t.query=function(e,n){var i=t.triggerCharMap[e];i.showMenu(),i.search({term:n}),i.typedTerm=n},t.defaultSearch=function(e){var n=[];angular.forEach(t.items,function(t){t.label.toUpperCase().indexOf(e.term.toUpperCase())>=0&&n.push(t)}),t.localItems=n},t.bridgeSearch=function(e){var n=r.mentioSearch?t.search:t.defaultSearch;n({term:e})},t.defaultSelect=function(e){return t.defaultTriggerChar+e.item.label},t.bridgeSelect=function(e){var n=r.mentioSelect?t.select:t.defaultSelect;return n({item:e})},t.setTriggerText=function(e){t.syncTriggerText&&(t.typedTerm=e)},t.replaceText=function(i,r){var o=t.triggerCharMap[i],a=o.select({item:r});if(e.replaceTriggerText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.triggerCharSet,a),t.setTriggerText(""),t.isContentEditable()){t.contentEditableMenuPasted=!0;var c=n(function(){t.contentEditableMenuPasted=!1},100);t.$on("$destroy",function(){n.cancel(c)})}},t.hideAll=function(){for(var e in t.triggerCharMap)t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].hideMenu()},t.getActiveMenuScope=function(){for(var e in t.triggerCharMap)if(t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].visible)return t.triggerCharMap[e];return null},t.selectActive=function(){for(var e in t.triggerCharMap)t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].visible&&t.triggerCharMap[e].selectActive()},t.isActive=function(){for(var e in t.triggerCharMap)if(t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].visible)return!0;return!1},t.isContentEditable=function(){return"INPUT"!==t.targetElement.nodeName&&"TEXTAREA"!==t.targetElement.nodeName},t.replaceMacro=function(i){var r=n(function(){e.replaceMacroText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.macros,t.macros[i])},300);t.$on("$destroy",function(){n.cancel(r)})},t.addMenu=function(e){e.parentScope&&t.triggerCharMap.hasOwnProperty(e.triggerChar)||(t.triggerCharMap[e.triggerChar]=e,void 0===t.triggerCharSet&&(t.triggerCharSet=[]),t.triggerCharSet.push(e.triggerChar),e.setParent(t))},t.$on("menuCreated",function(e,n){r.id===n.targetElement&&t.addMenu(n.scope)}),i.on("click",function(){t.isActive()&&t.$apply(function(){t.hideAll()})}),i.on("keydown keypress paste",function(e){var n=t.getActiveMenuScope();n&&(9===e.which&&n.$apply(function(){n.selectActive()}),27===e.which&&(e.preventDefault(),n.$apply(function(){n.hideMenu()})),40===e.which&&(e.preventDefault(),n.$apply(function(){n.activateNextItem()})),38===e.which&&(e.preventDefault(),n.$apply(function(){n.activatePreviousItem()})),(13===e.which||32===e.which)&&(e.preventDefault(),n.$apply(function(){n.selectActive()})))})},link:function(n,i,r){if(n.triggerCharMap={},r.$set("autocomplete","off"),r.mentioItems){n.localItems=[],n.parentScope=n;var o=r.mentioSearch?' mentio-items="items"':' mentio-items="localItems"';n.defaultTriggerChar=r.mentioTriggerChar?n.$eval(r.mentioTriggerChar):"@";var a='<mentio-menu mentio-search="bridgeSearch(term)" mentio-select="bridgeSelect(item)"'+o;r.mentioTemplateUrl&&(a=a+' mentio-template-url="'+r.mentioTemplateUrl+'"'),a=a+" mentio-trigger-char=\"'"+n.defaultTriggerChar+'\'" mentio-parent-scope="parentScope"/>';var c=t(a),l=c(n);i.parent().append(l)}r.mentioTypedTerm&&(n.syncTriggerText=!0),n.$watch("ngModel",function(){if(n.contentEditableMenuPasted)return void(n.contentEditableMenuPasted=!1);var t=e.getTriggerInfo(n.triggerCharSet);if(void 0!==t)n.targetElement=t.mentionSelectedElement,n.targetElementPath=t.mentionSelectedPath,n.targetElementSelectedOffset=t.mentionSelectedOffset,n.setTriggerText(t.mentionText),n.query(t.mentionTriggerChar,t.mentionText);else{n.setTriggerText(""),n.hideAll();var i=e.getMacroMatch(n.macros);void 0!==i&&(n.targetElement=i.macroSelectedElement,n.targetElementPath=i.macroSelectedPath,n.targetElementSelectedOffset=i.macroSelectedOffset,n.replaceMacro(i.macroText))}})}}}).directive("mentioMenu",function(e,t,n,i,r){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"=mentioTriggerChar",forElem:"=mentioFor",parentScope:"=mentioParentScope"},templateUrl:function(e,t){return void 0!==t.mentioTemplateUrl?t.mentioTemplateUrl:"mentio-menu.tpl.html"},controller:function(e){e.visible=!1,this.activate=e.activate=function(t){e.activeItem=t},this.isActive=e.isActive=function(t){return e.activeItem===t},this.selectItem=e.selectItem=function(t){e.hideMenu(),e.parentMentio.replaceText(e.triggerChar,t)},e.activateNextItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[0===t?e.items.length-1:t-1])},e.selectActive=function(){e.selectItem(e.activeItem)},e.isVisible=function(){return e.visible},e.showMenu=function(){e.visible||(e.requestVisiblePendingSearch=!0)},e.setParent=function(t){e.parentMentio=t}},link:function(o,a){if(a[0].parentNode.removeChild(a[0]),r[0].body.appendChild(a[0]),o.menuElement=a,o.parentScope)o.parentScope.addMenu(o);else{if(!o.forElem)return void n.error("mentio-menu requires a target element in tbe mentio-for attribute");if(!o.triggerChar)return void n.error("mentio-menu requires a trigger char");var c=r[0].querySelector("#"+o.forElem);if(c){var l=angular.element(c),s=l.attr("mentio");void 0!==s?(t.$broadcast("menuCreated",{targetElement:o.forElem,scope:o}),o.targetElement=l):n.error("Error, no mentio directive on target element "+o.forElem)}else n.error("Error, no such element: "+o.forElem)}angular.element(i).bind("resize",function(){if(o.isVisible()){var t=[];t.push(o.triggerChar),e.popUnderMention(t,a)}}),o.$watch("items",function(e){e&&e.length>0?(o.activate(e[0]),!o.visible&&o.requestVisiblePendingSearch&&(o.visible=!0,o.requestVisiblePendingSearch=!1)):o.hideMenu()}),o.$watch("isVisible()",function(t){if(t){var n=[];n.push(o.triggerChar),e.popUnderMention(n,a)}}),o.hideMenu=function(){o.visible=!1,a.css("display","none")}}}}).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,i){e.$watch(function(){return i.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){i.activate(e.item)})}),t.bind("click",function(t){t.preventDefault(),e.$apply(function(){i.selectItem(e.item)})})}}}).filter("unsafe",function(e){return function(t){return e.trustAsHtml(t)}}).filter("mentioHighlight",function(){function e(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(t,n,i){if(n){var r=i?'<span class="'+i+'">$&</span>':"<strong>$&</strong>";return(""+t).replace(new RegExp(e(n),"gi"),r)}return t}}),angular.module("mentio").factory("mentioUtil",function(e,t,n,i){function r(e,t){var n,r=p(e);void 0!==r?(n=a()?S(document.activeElement,r.mentionPosition):v(r.mentionPosition),t.css({top:n.top+"px",left:n.left+"px",position:"absolute",zIndex:100,display:"block"}),i(function(){o(t)},0)):t.css({display:"none"})}function o(t){for(var n,i=20,r=100,o=t[0];void 0===n||0===n.height;)if(n=o.getBoundingClientRect(),0===n.height&&(o=o.childNodes[0],!o.getBoundingClientRect))return;var a=n.top,c=a+n.height;if(0>a)e.scrollTo(0,e.pageYOffset+n.top-i);else if(c>e.innerHeight){var l=e.pageYOffset+n.top-i;l-e.pageYOffset>r&&(l=e.pageYOffset+r);var s=e.pageYOffset-(e.innerHeight-c);s>l&&(s=l),e.scrollTo(0,s)}}function a(){var e=document.activeElement;if(null!==e){var t=e.nodeName;return"INPUT"===t||"TEXTAREA"===t}return!1}function c(e,t,n){for(var i,r=e,o=0;o<t.length;o++){if(r=r.childNodes[t[o]],void 0===r)return;for(;r.length<n;)n-=r.length,r=r.nextSibling}if(document.selection&&document.selection.createRange)i=document.selection.createRange().duplicate(),i.select(r),i.selectStartOffset(n),i.selectEndOffset(n),i.collapse(!0),document.selection.removeAllRanges(),document.selection.addRange(i);else if(window.getSelection){var a=window.getSelection();i=document.createRange(),i.setStart(r,n),i.setEnd(r,n),i.collapse(!0),a.removeAllRanges(),a.addRange(i),e.focus()}}function l(e,t,n){var i,r;if(document.selection&&document.selection.createRange)i=document.selection.createRange().duplicate(),i.selectStartOffset(t),i.selectEndOffset(n),i.collapse(!1),i.deleteContents(),i.pasteHTML(e);else if(window.getSelection){r=window.getSelection(),i=document.createRange(),i.setStart(r.anchorNode,t),i.setEnd(r.anchorNode,n),i.deleteContents();var o=document.createElement("div");o.innerHTML=e;for(var a,c,l=document.createDocumentFragment();a=o.firstChild;)c=l.appendChild(a);i.insertNode(l),c&&(i=i.cloneRange(),i.setStartAfter(c),i.collapse(!0),r.removeAllRanges(),r.addRange(i))}}function s(e,t,n){var i=e.nodeName;"INPUT"===i||"TEXTAREA"===i?e!==document.activeElement&&e.focus():c(e,t,n)}function u(e,t,n,i,r){s(e,t,n);var o=f(i);if(void 0!==o){var c=document.activeElement;if(a())if(document.selection){c.focus();var u=document.selection.createRange();u.selectStartOffset(o.macroPosition),u.selectEndOffset(o.macroPosition+o.macroText.length),u.text=r}else{var d=o.macroPosition,m=o.macroPosition+o.macroText.length;c.value=c.value.substring(0,d)+r+c.value.substring(m,c.value.length),c.selectionStart=d+r.length,c.selectionEnd=d+r.length}else l(r,o.macroPosition,o.macroPosition+o.macroText.length)}}function d(e,t,n,i,r){s(e,t,n);var o=p(i);if(void 0!==o)if(a()){var c=document.activeElement;if(r+=" ",document.selection){c.focus();var u=document.selection.createRange();u.selectStartOffset(o.mentionPosition),u.selectEndOffset(o.mentionPosition+o.mentionText.length),u.text=r}else{var d=o.mentionPosition,m=o.mentionPosition+o.mentionText.length+1;c.value=c.value.substring(0,d)+r+c.value.substring(m,c.value.length),c.selectionStart=d+r.length,c.selectionEnd=d+r.length}}else r+=" ",l(r,o.mentionPosition,o.mentionPosition+o.mentionText.length+1)}function m(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++){var n=e.parentNode.childNodes[t];if(n===e)return t}}function f(e){var t,n,i=[];if(a())t=document.activeElement;else{var r=g();r&&(t=r.selected,i=r.path,n=r.offset)}var o=h();if(void 0!==o&&null!==o){var c;if(angular.forEach(e,function(e,r){var a=o.toUpperCase().lastIndexOf(r.toUpperCase());if(a>=0&&r.length+a===o.length){var l=a-1;(0===a||" "===o.charAt(l)||" "===o.charAt(l))&&(c={macroPosition:a,macroText:r,macroSelectedElement:t,macroSelectedPath:i,macroSelectedOffset:n})}}),c)return c}}function g(){var e,t=window.getSelection(),n=t.anchorNode,i=[];if(null!=n){for(var r,o=n.contentEditable;null!==n&&"true"!==o;)r=m(n),i.push(r),n=n.parentNode,null!==n&&(o=n.contentEditable);return i.reverse(),e=t.getRangeAt(0).startOffset,{selected:n,path:i,offset:e}}}function p(e){var t,n,i;if(a())t=document.activeElement;else{var r=g();r&&(t=r.selected,n=r.path,i=r.offset)}var o=h();if(void 0!==o&&null!==o){var c,l=-1;if(e.forEach(function(e){var t=o.lastIndexOf(e);t>l&&(l=t,c=e)}),0===l||/[\xA0\s]/g.test(o.substring(l-1,l))){var s=o.substring(l+1,o.length);if(c=o.substring(l,l+1),!/[\xA0\s]/g.test(s))return{mentionPosition:l,mentionText:s,mentionSelectedElement:t,mentionSelectedPath:n,mentionSelectedOffset:i,mentionTriggerChar:c}}}}function h(){var e;if(a()){var t=document.activeElement;if(void 0!==document.selection){t.focus();var n=document.selection.createRange();e=n.text}else if(void 0!==t.selectionStart){var i=t.selectionStart;e=t.value.substring(0,i)}}else{var r=window.getSelection().anchorNode;if(null!=r){var o=r.textContent,c=window.getSelection().getRangeAt(0).startOffset;c>=0&&(e=o.substring(0,c))}}return e}function v(e){var t,n,i="﻿",r="&#xfeff;",o="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2);if(document.selection&&document.selection.createRange)n=document.selection.createRange().duplicate(),n.selectStartOffset(e),n.selectEndOffset(e),n.collapse(!1),n.pasteHTML('<span id="'+o+'" style="position: relative;">'+r+"</span>"),t=document.getElementById(o);else if(window.getSelection){var a=window.getSelection();n=document.createRange(),n.setStart(a.anchorNode,e),n.setEnd(a.anchorNode,e),n.collapse(!1),t=document.createElement("span"),t.id=o,t.appendChild(document.createTextNode(i)),n.insertNode(t)}var c=t,l={left:0,top:t.offsetHeight};do l.left+=c.offsetLeft,l.top+=c.offsetTop;while(c=c.offsetParent);return t.parentNode.removeChild(t),l}function S(e,t){var n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],i=null!==window.mozInnerScreenX,r=document.createElement("div");r.id="input-textarea-caret-position-mirror-div",document.body.appendChild(r);var o=r.style,a=window.getComputedStyle?getComputedStyle(e):e.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",n.forEach(function(e){o[e]=a[e]}),i?(o.width=parseInt(a.width)-2+"px",e.scrollHeight>parseInt(a.height)&&(o.overflowY="scroll")):o.overflow="hidden",r.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(r.textContent=r.textContent.replace(/\s/g," "));var c=document.createElement("span");c.textContent=e.value.substring(t)||".",r.appendChild(c);var l={top:c.offsetTop+parseInt(a.borderTopWidth)+c.offsetHeight,left:c.offsetLeft+parseInt(a.borderLeftWidth)},s=e;do l.left+=s.offsetLeft,l.top+=s.offsetTop;while(s=s.offsetParent);return document.body.removeChild(r),l}return{popUnderMention:r,replaceMacroText:u,replaceTriggerText:d,getMacroMatch:f,getTriggerInfo:p,selectElement:c,getTextAreaOrInputUnderlinePosition:S,getTextPrecedingCurrentSelection:h,getContentEditableSelectedPath:g,getNodePositionInParent:m,getContentEditableCaretPosition:v,pasteHtml:l,resetSelection:s,scrollIntoView:o}}),angular.module("mentio").run(["$templateCache",function(e){e.put("mentio-menu.tpl.html",'<ul class="dropdown-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:triggerText:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);
"use strict";var NON_TRIGGER_CHAR="2";angular.module("mentio",[]).directive("mentio",["mentioUtil","$document","$compile","$log","$timeout",function(e,t,n,r,i){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",typedTerm:"=mentioTypedTerm",altId:"=mentioId",iframeElement:"=mentioIframeElement",requireLeadingSpace:"=mentioRequireLeadingSpace",selectNotFound:"=mentioSelectNotFound",noTriggerChar:"=mentioNoTriggerChar",ngModel:"="},controller:["$scope","$timeout","$attrs",function(n,r,i){n.context={iframe:n.iframeElement,noTriggerChar:n.noTriggerChar},n.query=function(e,t){console.log("triggerChar=",e,n.triggerCharMap),console.log("triggerText=",t),n.context&&console.log("triggerOffset=",n.context.triggerOffset);var r=n.triggerCharMap[e];r.showMenu(),r.search({term:t.trim()}),r.typedTerm=t.trim()},n.defaultSearch=function(e){var t=[];angular.forEach(n.items,function(n){n.label.toUpperCase().indexOf(e.term.toUpperCase())>=0&&t.push(n)}),n.localItems=t},n.bridgeSearch=function(e){var t=i.mentioSearch?n.search:n.defaultSearch;t({term:e})},n.defaultSelect=function(e){return n.defaultTriggerChar+e.item.label},n.bridgeSelect=function(e){var t=i.mentioSelect?n.select:n.defaultSelect;return t({item:e})},n.setTriggerText=function(e){n.syncTriggerText&&(n.typedTerm=e.trim())},n.replaceText=function(t,i){if(console.log("$scope.replaceText",t,i),e.replaceTriggerText(n.context,n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.triggerCharSet,t,n.requireLeadingSpace,i),n.hideAll(),i)console.log("not setting bounce filter");else{if(n.setTriggerText(""),console.log("replaceText delete triggerOffset"),delete n.context.triggerOffset,n.isContentEditable()){console.log("setting bounce filter"),n.contentEditableMenuPasted=!0;var o=r(function(){n.contentEditableMenuPasted=!1},200);n.$on("$destroy",function(){r.cancel(o)})}angular.element(n.targetElement).triggerHandler("change")}},n.hideAll=function(){for(var e in n.triggerCharMap)n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].hideMenu()},n.getActiveMenuScope=function(){for(var e in n.triggerCharMap)if(n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible)return n.triggerCharMap[e];return null},n.selectActive=function(){for(var e in n.triggerCharMap)n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible&&n.triggerCharMap[e].selectActive()},n.isActive=function(){for(var e in n.triggerCharMap)if(n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible)return!0;return!1},n.isContentEditable=function(){return"INPUT"!==n.targetElement.nodeName&&"TEXTAREA"!==n.targetElement.nodeName},n.replaceMacro=function(t,i){i?e.replaceMacroText(n.context,n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.macros,n.macros[t]):(n.replacingMacro=!0,n.timer=r(function(){e.replaceMacroText(n.context,n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.macros,n.macros[t]),angular.element(n.targetElement).triggerHandler("change"),n.replacingMacro=!1},300),n.$on("$destroy",function(){r.cancel(n.timer)}))},n.addMenu=function(e){e.parentScope&&n.triggerCharMap.hasOwnProperty(e.triggerChar)||(console.log("triggerChar=",e.triggerChar),"(none)"===e.triggerChar?n.triggerCharMap[NON_TRIGGER_CHAR]=e:(n.triggerCharMap[e.triggerChar]=e,void 0===n.triggerCharSet&&(n.triggerCharSet=[]),n.triggerCharSet.push(e.triggerChar)),e.setParent(n))},n.handleEvent=function(e,t){function n(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}return 9===t.which||13===t.which?(n(t),e.selectActive(),!1):27===t.which?(n(t),e.$apply(function(){e.hideMenu()}),!1):40===t.which?(n(t),e.$apply(function(){e.activateNextItem()}),!1):38===t.which?(n(t),e.$apply(function(){e.activatePreviousItem()}),!1):37===t.which||39===t.which?(n(t),!1):void 0},n.$on("menuCreated",function(e,t){(void 0!==i.id||void 0!==i.mentioId)&&(i.id===t.targetElement||void 0!==i.mentioId&&n.altId===t.targetElement)&&n.addMenu(t.scope)}),t.on("click",function(){n.isActive()&&n.$apply(function(){n.hideAll()})}),t.on("keydown keypress paste",function(t){var r=n.getActiveMenuScope();if(r)return n.handleEvent(r,t);if(n.noTriggerChar){console.log("keydown trying to get triggerinfo");var i=e.getTriggerInfo(n.context,n.triggerCharSet,n.requireLeadingSpace,!1);console.log("mentionInfo=",i)}})}],link:function(t,o,a){function c(e){var n=t.getActiveMenuScope();return n?t.handleEvent(n,e):void 0}if(t.triggerCharMap={},t.targetElement=o,a.$set("autocomplete","off"),a.mentioItems){t.localItems=[],t.parentScope=t;var l=a.mentioSearch?' mentio-items="items"':' mentio-items="localItems"';t.defaultTriggerChar=t.noTriggerChar?"(none)":a.mentioTriggerChar?t.$eval(a.mentioTriggerChar):"@";var g='<mentio-menu mentio-search="bridgeSearch(term)" mentio-select="bridgeSelect(item)"'+l;a.mentioTemplateUrl&&(g=g+' mentio-template-url="'+a.mentioTemplateUrl+'"'),g=g+" mentio-trigger-char=\"'"+t.defaultTriggerChar+'\'" mentio-parent-scope="parentScope"/>';var s=n(g),f=s(t);o.parent().append(f),t.$on("$destroy",function(){f.remove()})}a.mentioTypedTerm&&(t.syncTriggerText=!0),t.$watch("iframeElement",function(e){if(e){var n=e.contentWindow.document;n.addEventListener("click",function(){t.isActive()&&t.$apply(function(){t.hideAll()})}),n.addEventListener("keydown",c,!0),t.$on("$destroy",function(){n.removeEventListener("keydown",c)})}}),t.$watch("ngModel",function(n){if(console.log("newValue=",n),n&&""!==n){if(!t.noTriggerChar&&!t.triggerCharSet)return void r.error("Error, no mentio-items attribute was provided, and no separate mentio-menus were specified.  Nothing to do.");if(t.contentEditableMenuPasted)return console.log("bounced"),void(t.contentEditableMenuPasted=!1);t.replacingMacro&&(i.cancel(t.timer),t.replacingMacro=!1);var o=t.isActive(),a=t.isContentEditable(),c=e.getTriggerInfo(t.context,t.triggerCharSet,t.requireLeadingSpace,o),l=c&&(a&&c.mentionTriggerChar===t.currentMentionTriggerChar||!a&&c.mentionPosition===t.currentMentionPosition);if(console.log("continuing = ",l),c&&(!o||o&&l))c.mentionSelectedElement&&(t.targetElement=c.mentionSelectedElement,t.targetElementPath=c.mentionSelectedPath,t.targetElementSelectedOffset=c.mentionSelectedOffset),t.setTriggerText(c.mentionText),t.currentMentionPosition=c.mentionPosition,t.currentMentionTriggerChar=c.mentionTriggerChar,t.query(c.mentionTriggerChar,c.mentionText);else{var g=t.typedTerm;t.setTriggerText(""),console.log("watch no triggerinfo delete triggerOffset"),delete t.context.triggerOffset,t.hideAll();var s=e.getMacroMatch(t.context,t.macros);if(s)t.targetElement=s.macroSelectedElement,t.targetElementPath=s.macroSelectedPath,t.targetElementSelectedOffset=s.macroSelectedOffset,t.replaceMacro(s.macroText,s.macroHasTrailingSpace);else if(t.selectNotFound&&g&&""!==g){var f=t.triggerCharMap[t.currentMentionTriggerChar];if(f){var m=f.select({item:{label:g}});"function"==typeof m.then?m.then(t.replaceText):t.replaceText(m,!0)}}}}})}}}]).directive("mentioMenu",["mentioUtil","$rootScope","$log","$window","$document",function(e,t,n,r,i){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"=mentioTriggerChar",forElem:"=mentioFor",parentScope:"=mentioParentScope"},templateUrl:function(e,t){return t.mentioTemplateUrl||"mentio-menu.tpl.html"},controller:["$scope",function(e){e.visible=!1,this.activate=e.activate=function(t){e.activeItem=t},this.isActive=e.isActive=function(t){return e.activeItem===t},this.selectItem=e.selectItem=function(t){var n=e.select({item:t});"function"==typeof n.then?n.then(e.parentMentio.replaceText):e.parentMentio.replaceText(n)},e.activateNextItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[0===t?e.items.length-1:t-1])},e.selectActive=function(){e.selectItem(e.activeItem)},e.isVisible=function(){return e.visible},e.showMenu=function(){e.visible||(e.requestVisiblePendingSearch=!0)},e.setParent=function(t){e.parentMentio=t,e.targetElement=t.targetElement}}],link:function(o,a){if(a[0].parentNode.removeChild(a[0]),i[0].body.appendChild(a[0]),o.menuElement=a,o.parentScope)o.parentScope.addMenu(o);else{if(!o.forElem)return void n.error("mentio-menu requires a target element in tbe mentio-for attribute");if(!o.triggerChar)return void n.error("mentio-menu requires a trigger char");t.$broadcast("menuCreated",{targetElement:o.forElem,scope:o})}angular.element(r).bind("resize",function(){if(o.isVisible()){var t=[];t.push(o.triggerChar),e.popUnderMention(o.parentMentio.context,t,a,o.requireLeadingSpace)}}),o.$watch("items",function(e){e&&e.length>0?(o.activate(e[0]),!o.visible&&o.requestVisiblePendingSearch&&(o.visible=!0,o.requestVisiblePendingSearch=!1)):o.hideMenu()}),o.$watch("isVisible()",function(t){if(t){var n=[];n.push(o.triggerChar),e.popUnderMention(o.parentMentio.context,n,a,o.requireLeadingSpace)}}),o.hideMenu=function(){o.visible=!1,a.css("display","none"),console.log("hideMenu delete triggerOffset"),delete o.parentMentio.context.triggerOffset}}}}]).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,r){e.$watch(function(){return r.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){r.activate(e.item)})}),t.bind("click",function(t){t.preventDefault(),r.selectItem(e.item)})}}}).filter("unsafe",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("mentioHighlight",function(){function e(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(t,n,r){if(n){var i=r?'<span class="'+r+'">$&</span>':"<strong>$&</strong>";return(""+t).replace(new RegExp(e(n),"gi"),i)}return t}});var NON_TRIGGER_CHAR="2";angular.module("mentio").factory("mentioUtil",["$window","$location","$anchorScroll","$timeout",function(e,t,n,r){function i(e,t,n,i){var c,l=p(e,t,i,!1);void 0!==l?(c=a(e)?x(e,T(e).activeElement,l.mentionPosition):E(e,l.mentionPosition),n.css({top:c.top+"px",left:c.left+"px",position:"absolute",zIndex:100,display:"block"}),r(function(){o(e,n)},0)):n.css({display:"none"})}function o(t,n){for(var r,i=20,o=100,a=n[0];void 0===r||0===r.height;)if(r=a.getBoundingClientRect(),0===r.height&&(a=a.childNodes[0],void 0===a||!a.getBoundingClientRect))return;var c=r.top,l=c+r.height;if(0>c)e.scrollTo(0,e.pageYOffset+r.top-i);else if(l>e.innerHeight){var g=e.pageYOffset+r.top-i;g-e.pageYOffset>o&&(g=e.pageYOffset+o);var s=e.pageYOffset-(e.innerHeight-l);s>g&&(s=g),e.scrollTo(0,s)}}function a(e){var t=T(e).activeElement;if(null!==t){var n=t.nodeName,r=t.getAttribute("type");return"INPUT"===n&&"text"===r||"TEXTAREA"===n}return!1}function c(e,t,n,r){var i,o=t;if(n)for(var a=0;a<n.length;a++){if(o=o.childNodes[n[a]],void 0===o)return;for(;o.length<r;)r-=o.length,o=o.nextSibling;0!==o.childNodes.length||o.length||(o=o.previousSibling)}var c=v(e);i=T(e).createRange(),i.setStart(o,r),i.setEnd(o,r),i.collapse(!0);try{c.removeAllRanges()}catch(l){}c.addRange(i),t.focus()}function l(e,t,n,r){console.log("paste",t,n,r);var i,o;o=v(e),i=T(e).createRange(),i.setStart(o.anchorNode,n),i.setEnd(o.anchorNode,r),i.deleteContents();var a=T(e).createElement("div");a.innerHTML=t;for(var c,l,g=T(e).createDocumentFragment();c=a.firstChild;)l=g.appendChild(c);i.insertNode(g),l&&(i=i.cloneRange(),i.setStartAfter(l),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}function g(e,t,n,r){var i=t.nodeName;"INPUT"===i||"TEXTAREA"===i?t!==T(e).activeElement&&t.focus():c(e,t,n,r)}function s(e,t,n,r,i,o){g(e,t,n,r);var c=u(e,i);if(c.macroHasTrailingSpace&&(c.macroText=c.macroText+" ",o+=" "),void 0!==c){var s=T(e).activeElement;if(a(e)){var f=c.macroPosition,m=c.macroPosition+c.macroText.length;s.value=s.value.substring(0,f)+o+s.value.substring(m,s.value.length),s.selectionStart=f+o.length,s.selectionEnd=f+o.length}else l(e,o,c.macroPosition,c.macroPosition+c.macroText.length)}}function f(e,t,n,r,i,o,c,s){g(e,t,n,r);var f=p(e,i,c,!0,s);if(f)if(a()){var m=T(e).activeElement;o+=" ";var u=f.mentionPosition,d=f.mentionPosition+f.mentionText.length+1;m.value=m.value.substring(0,u)+o+m.value.substring(d,m.value.length),m.selectionStart=u+o.length,m.selectionEnd=u+o.length}else{e.noTriggerChar||(o+=" "),console.log(f);var h=e.noTriggerChar?f.mentionText.length:f.mentionText.length+1;l(e,o,f.mentionPosition,f.mentionPosition+h)}}function m(e,t){if(null===t.parentNode)return 0;for(var n=0;n<t.parentNode.childNodes.length;n++){var r=t.parentNode.childNodes[n];if(r===t)return n}}function u(e,t){var n,r,i=[];if(a(e))n=T(e).activeElement;else{var o=d(e);o&&(n=o.selected,i=o.path,r=o.offset)}var c=S(e);if(c){var l,g=!1;if(c.length>0&&(" "===c.charAt(c.length-1)||" "===c.charAt(c.length-1))&&(g=!0,c=c.substring(0,c.length-1)),angular.forEach(t,function(e,t){var o=c.toUpperCase().lastIndexOf(t.toUpperCase());if(o>=0&&t.length+o===c.length){var a=o-1;(0===o||" "===c.charAt(a)||" "===c.charAt(a))&&(l={macroPosition:o,macroText:t,macroSelectedElement:n,macroSelectedPath:i,macroSelectedOffset:r,macroHasTrailingSpace:g})}}),l)return l}}function d(e){var t,n=v(e),r=n.anchorNode,i=[];if(null!=r){for(var o,a=r.contentEditable;null!==r&&"true"!==a;)o=m(e,r),i.push(o),r=r.parentNode,null!==r&&(a=r.contentEditable);return i.reverse(),t=n.getRangeAt(0).startOffset,{selected:r,path:i,offset:t}}}function h(e,t,n,r){if(e&&e.hasOwnProperty("triggerOffset"))return console.log("has triggerOffset - returning",e.triggerOffset),{triggerChar:NON_TRIGGER_CHAR,mostRecentTriggerCharPos:e.triggerOffset};var i,o=-1;return e&&e.noTriggerChar?(i=NON_TRIGGER_CHAR,o=n.length-1,console.log("no triggerOffset - assigning",o,n)):t.forEach(function(e){var t=n.lastIndexOf(e);t>o&&(o=t,i=e)}),o>=0&&(0===o||!r||" "===n.charAt(o-1)||" "===n.charAt(o-1))?{triggerChar:i,mostRecentTriggerCharPos:o}:void 0}function p(e,t,n,r,i){var o,c,l;if(a(e))o=T(e).activeElement;else{var g=d(e);g&&(o=g.selected,c=g.path,l=g.offset)}var s=S(e);if(console.log("effectiveRange=",s),s){var f=h(e,t,s,n);if(console.log("triggerInfo=",f),f){var m=f.mostRecentTriggerCharPos,u=e&&e.noTriggerChar,p=u?m:m+1,v=u?f.triggerChar:s.substring(m,p),C=s.substring(p,s.length),E=C.substring(0,1),b=C.length>0&&(" "===E||" "===E);if(i&&(C=C.trim()),!b&&(r||!/[\xA0\s]/g.test(C)))return{mentionPosition:m,mentionText:C,mentionSelectedElement:o,mentionSelectedPath:c,mentionSelectedOffset:l,mentionTriggerChar:v}}}}function v(e){return e&&e.iframe?e.iframe.contentWindow.getSelection():window.getSelection()}function T(e){return e&&e.iframe?e.iframe.contentWindow.document:document}function C(e){var t=!1,n=v(e);if(!n.isCollapsed){var r=T(e).createRange();r.setStart(n.anchorNode,n.anchorOffset),r.setEnd(n.focusNode,n.focusOffset),t=r.collapsed,r.detach()}return t}function S(e){var t;if(a(e)){var n=T(e).activeElement,r=n.selectionStart;t=n.value.substring(0,r)}else{var i=C(e),o=v(e),c=i?o.focusNode:o.anchorNode,l=i?o.focusOffset:o.anchorOffset;if(c){var g=c.textContent;l>=0&&(t=g.substring(0,l))}}return t}function E(e,t){var n,r,i="﻿",o="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),a=v(e),c=a.getRangeAt(0);r=T(e).createRange(),r.setStart(a.anchorNode,t),r.setEnd(a.anchorNode,t),r.collapse(!1),n=T(e).createElement("span"),n.id=o,n.appendChild(T(e).createTextNode(i)),r.insertNode(n),a.removeAllRanges(),a.addRange(c);var l={left:0,top:n.offsetHeight};return b(e,n,l),n.parentNode.removeChild(n),l}function b(e,t,n){for(var r=t,i=e?e.iframe:null;r;)n.left+=r.offsetLeft,n.top+=r.offsetTop,r!==T().body&&(n.top-=r.scrollTop,n.left-=r.scrollLeft),r=r.offsetParent,!r&&i&&(r=i,i=null)}function x(e,t,n){var r=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],i=null!==window.mozInnerScreenX,o=T(e).createElement("div");o.id="input-textarea-caret-position-mirror-div",T(e).body.appendChild(o);var a=o.style,c=window.getComputedStyle?getComputedStyle(t):t.currentStyle;a.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(a.wordWrap="break-word"),a.position="absolute",a.visibility="hidden",r.forEach(function(e){a[e]=c[e]}),i?(a.width=parseInt(c.width)-2+"px",t.scrollHeight>parseInt(c.height)&&(a.overflowY="scroll")):a.overflow="hidden",o.textContent=t.value.substring(0,n),"INPUT"===t.nodeName&&(o.textContent=o.textContent.replace(/\s/g," "));var l=T(e).createElement("span");l.textContent=t.value.substring(n)||".",o.appendChild(l);var g={top:l.offsetTop+parseInt(c.borderTopWidth)+parseInt(c.fontSize),left:l.offsetLeft+parseInt(c.borderLeftWidth)};return b(e,t,g),T(e).body.removeChild(o),g}return{popUnderMention:i,replaceMacroText:s,replaceTriggerText:f,getMacroMatch:u,getTriggerInfo:p,selectElement:c,getTextAreaOrInputUnderlinePosition:x,getTextPrecedingCurrentSelection:S,getContentEditableSelectedPath:d,getNodePositionInParent:m,getContentEditableCaretPosition:E,pasteHtml:l,resetSelection:g,scrollIntoView:o}}]),angular.module("mentio").run(["$templateCache",function(e){e.put("mentio-menu.tpl.html",'<style>\n.scrollable-menu {\n    height: auto;\n    max-height: 300px;\n    overflow: auto;\n}\n\n.menu-highlighted {\n    font-weight: bold;\n}\n</style>\n<ul class="dropdown-menu scrollable-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:typedTerm:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);
"use strict";angular.module("mentio",[]).directive("mentio",function(e,t){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",typedTerm:"=mentioTypedTerm",ngModel:"="},controller:function(t,n,i,o){t.query=function(e,n){var i=t.map[e];i.showMenu(),i.search({term:n}),i.typedTerm=n},t.defaultSearch=function(e){var n=[];angular.forEach(t.items,function(t){t.label.toUpperCase().indexOf(e.term.toUpperCase())>=0&&n.push(t)}),t.localItems=n},t.bridgeSearch=function(e){var n=o.mentioSearch?t.search:t.defaultSearch;n({term:e})},t.defaultSelect=function(e){return t.defaultTriggerChar+e.item.label},t.bridgeSelect=function(e){var n=o.mentioSelect?t.select:t.defaultSelect;return n({item:e})},t.setTriggerText=function(e){t.syncTriggerText&&(t.typedTerm=e)},t.replaceText=function(i,o){var r=t.map[i],a=r.select({item:o});if(e.replaceTriggerText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.triggerCharSet,a),t.setTriggerText(""),t.isContentEditable()){t.contentEditableMenuPasted=!0;var c=n(function(){t.contentEditableMenuPasted=!1},100);t.$on("$destroy",function(){n.cancel(c)})}},t.hideAll=function(){for(var e in t.map)t.map.hasOwnProperty(e)&&t.map[e].hideMenu()},t.getActiveMenuScope=function(){for(var e in t.map)if(t.map.hasOwnProperty(e)&&t.map[e].visible)return t.map[e];return null},t.selectActive=function(){for(var e in t.map)t.map.hasOwnProperty(e)&&t.map[e].visible&&t.map[e].selectActive()},t.isActive=function(){for(var e in t.map)if(t.map.hasOwnProperty(e)&&t.map[e].visible)return!0;return!1},t.isContentEditable=function(){return"INPUT"!==t.targetElement.nodeName&&"TEXTAREA"!==t.targetElement.nodeName},t.replaceMacro=function(i){var o=n(function(){e.replaceMacroText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.macros,t.macros[i])},300);t.$on("$destroy",function(){n.cancel(o)})},t.addMenu=function(e){e.parentScope&&t.map.hasOwnProperty(e.triggerChar)||(t.map[e.triggerChar]=e,void 0===t.triggerCharSet&&(t.triggerCharSet=[]),t.triggerCharSet.push(e.triggerChar),e.setParent(t))},t.$on("menuCreated",function(e,n){o.id===n.targetElement&&t.addMenu(n.scope)}),i.on("click",function(){t.isActive()&&t.$apply(function(){t.hideAll()})}),i.on("keydown keypress paste",function(){var e=t.getActiveMenuScope();e&&(9===event.which&&e.$apply(function(){e.selectActive()}),27===event.which&&(event.preventDefault(),e.$apply(function(){e.hideMenu()})),40===event.which&&(event.preventDefault(),e.$apply(function(){e.activateNextItem()})),38===event.which&&(event.preventDefault(),e.$apply(function(){e.activatePreviousItem()})),(13===event.which||32===event.which)&&(event.preventDefault(),e.$apply(function(){e.selectActive()})))})},link:function(n,i,o){if(n.map={},o.$set("autocomplete","off"),o.mentioItems){n.localItems=[],n.parentScope=n;var r=o.mentioSearch?' mentio-items="items"':' mentio-items="localItems"';n.defaultTriggerChar=o.mentioTriggerChar?n.$eval(o.mentioTriggerChar):"@";var a='<mentio-menu  mentio-search="bridgeSearch(term)" mentio-select="bridgeSelect(item)"'+r+' mentio-template-url="'+o.mentioTemplateUrl+'" mentio-trigger-char="\''+n.defaultTriggerChar+'\'" mentio-parent-scope="parentScope"/>',c=t(a),l=c(n);i.parent().append(l)}o.mentioTypedTerm&&(n.syncTriggerText=!0),n.$watch("ngModel",function(){if(n.contentEditableMenuPasted)return void(n.contentEditableMenuPasted=!1);var t=e.getTriggerInfo(n.triggerCharSet);if(void 0!==t)n.targetElement=t.mentionSelectedElement,n.targetElementPath=t.mentionSelectedPath,n.targetElementSelectedOffset=t.mentionSelectedOffset,n.setTriggerText(t.mentionText),n.query(t.mentionTriggerChar,t.mentionText);else{n.setTriggerText(""),n.hideAll();var i=e.getMacroMatch(n.macros);void 0!==i&&(n.targetElement=i.macroSelectedElement,n.targetElementPath=i.macroSelectedPath,n.targetElementSelectedOffset=i.macroSelectedOffset,n.replaceMacro(i.macroText))}})}}}).directive("mentioMenu",function(e,t,n){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"=mentioTriggerChar",forElem:"=mentioFor",parentScope:"=mentioParentScope"},templateUrl:function(e,t){return"undefined"!==t.mentioTemplateUrl?t.mentioTemplateUrl:"mentio-menu.tpl.html"},controller:function(e){e.visible=!1,this.activate=e.activate=function(t){e.activeItem=t},this.isActive=e.isActive=function(t){return e.activeItem===t},this.selectItem=e.selectItem=function(t){e.visible=!1,e.parentMentio.replaceText(e.triggerChar,t)},e.activateNextItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[0===t?e.items.length-1:t-1])},e.selectActive=function(){e.selectItem(e.activeItem)},e.isVisible=function(){return e.visible},e.showMenu=function(){e.visible||(e.requestVisiblePendingSearch=!0)},e.hideMenu=function(){e.visible=!1},e.setParent=function(t){e.parentMentio=t}},link:function(i,o){if(o[0].parentNode.removeChild(o[0]),document.body.appendChild(o[0]),i.parentScope)i.parentScope.addMenu(i);else{var r=document.querySelector("#"+i.forElem);if(r){var a=angular.element(r),c=a.attr("mentio");void 0!==c?(t.$broadcast("menuCreated",{targetElement:i.forElem,scope:i}),i.targetElement=a):n.error("Error, no mentio directive on target element "+i.forElem)}else n.error("Error, no such element: "+i.forElem)}i.$watch("items",function(e){e&&e.length>0?(i.activate(e[0]),!i.visible&&i.requestVisiblePendingSearch&&(i.visible=!0,i.requestVisiblePendingSearch=!1)):i.visible=!1}),i.$watch("isVisible()",function(t){if(t){var n=[];n.push(i.triggerChar),e.popUnderMention(n,o)}else o.css("display","none")})}}}).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,i){e.$watch(function(){return i.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){i.activate(e.item)})}),t.bind("click",function(t){t.preventDefault(),e.$apply(function(){i.selectItem(e.item)})})}}}).filter("mentioHighlight",function(){function e(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(t,n,i){if(n){var o=i?'<span class="'+i+'">$&</span>':"<strong>$&</strong>";return(""+t).replace(new RegExp(e(n),"gi"),o)}return t}}),angular.module("mentio").factory("mentioUtil",function(){function e(e,n){var i,o=s(e);void 0!==o?(i=t()?u(document.activeElement,o.mentionPosition):d(o.mentionPosition),n.css({top:i.top+"px",left:i.left+"px",position:"absolute",zIndex:100,display:"block"})):n.css({display:"none"})}function t(){var e=document.activeElement;if(null!==e){var t=e.nodeName;return"INPUT"===t||"TEXTAREA"===t}return!1}function n(e,t,n){for(var i,o=e,r=0;r<t.length;r++){if(o=o.childNodes[t[r]],void 0===o)return;for(;o.length<n;)n-=o.length,o=o.nextSibling}if(document.selection&&document.selection.createRange)i=document.selection.createRange().duplicate(),i.select(o),i.selectStartOffset(n),i.selectEndOffset(n),i.collapse(!0),document.selection.removeAllRanges(),document.selection.addRange(i);else if(window.getSelection){var a=window.getSelection();i=document.createRange(),i.setStart(o,n),i.setEnd(o,n),i.collapse(!0),a.removeAllRanges(),a.addRange(i),e.focus()}}function i(e,t,n){var i,o;if(document.selection&&document.selection.createRange)i=document.selection.createRange().duplicate(),i.selectStartOffset(t),i.selectEndOffset(n),i.collapse(!1),i.deleteContents(),i.pasteHTML(e);else if(window.getSelection){o=window.getSelection(),i=document.createRange(),i.setStart(o.anchorNode,t),i.setEnd(o.anchorNode,n),i.deleteContents();var r=document.createElement("div");r.innerHTML=e;for(var a,c,l=document.createDocumentFragment();a=r.firstChild;)c=l.appendChild(a);i.insertNode(l),c&&(i=i.cloneRange(),i.setStartAfter(c),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}}function o(e,t,i){var o=e.nodeName;"INPUT"===o||"TEXTAREA"===o?e!==document.activeElement&&e.focus():n(e,t,i)}function r(e,n,r,a,c){o(e,n,r);var s=l(a);if(void 0!==s)if(t()){var m=document.activeElement;if(document.selection){m.focus();var d=document.selection.createRange();d.selectStartOffset(s.macroPosition),d.selectEndOffset(s.macroPosition+s.macroText.length),d.text=c}else{var u=s.macroPosition,f=s.macroPosition+s.macroText.length;m.value=m.value.substring(0,u)+c+m.value.substring(f,m.value.length),m.selectionStart=u+c.length,m.selectionEnd=u+c.length}}else i(c,s.macroPosition,s.macroPosition+s.macroText.length)}function a(e,n,r,a,c){o(e,n,r);var l=s(a);if(void 0!==l)if(t()){var m=document.activeElement;if(c+=" ",document.selection){m.focus();var d=document.selection.createRange();d.selectStartOffset(l.mentionPosition),d.selectEndOffset(l.mentionPosition+l.mentionText.length),d.text=c}else{var u=l.mentionPosition,f=l.mentionPosition+l.mentionText.length+1;m.value=m.value.substring(0,u)+c+m.value.substring(f,m.value.length),m.selectionStart=u+c.length,m.selectionEnd=u+c.length}}else c+=" ",i(c,l.mentionPosition,l.mentionPosition+l.mentionText.length+1)}function c(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++){var n=e.parentNode.childNodes[t];if(n===e)return t}}function l(e){var n,i,o=[];if(t())n=document.activeElement;else{var r=window.getSelection();if(n=r.anchorNode,null!=n){for(var a,l=n.contentEditable;null!==n&&"true"!==l;)a=c(n),o.push(a),n=n.parentNode,null!==n&&(l=n.contentEditable);o.reverse(),i=r.getRangeAt(0).startOffset}}var s=m();if(void 0!==s&&null!==s){var d;if(angular.forEach(e,function(e,t){var r=s.toUpperCase().lastIndexOf(t.toUpperCase());if(r>=0&&t.length+r===s.length){var a=r-1;(0===r||" "===s.charAt(a)||" "===s.charAt(a))&&(d={macroPosition:r,macroText:t,macroSelectedElement:n,macroSelectedPath:o,macroSelectedOffset:i})}}),d)return d}}function s(e){var n,i,o=[];if(t())n=document.activeElement;else{var r=window.getSelection();if(n=r.anchorNode,null!=n){for(var a,l=n.contentEditable;null!==n&&"true"!==l;)a=c(n),o.push(a),n=n.parentNode,null!==n&&(l=n.contentEditable);o.reverse(),i=r.getRangeAt(0).startOffset}}var s=m();if(void 0!==s&&null!==s){var d,u=-1;if(e.forEach(function(e){var t=s.lastIndexOf(e);t>u&&(u=t,d=e)}),0===u||/[\xA0\s]/g.test(s.substring(u-1,u))){var f=s.substring(u+1,s.length);if(d=s.substring(u,u+1),!/[\xA0\s]/g.test(f))return{mentionPosition:u,mentionText:f,mentionSelectedElement:n,mentionSelectedPath:o,mentionSelectedOffset:i,mentionTriggerChar:d}}}}function m(){var e;if(t()){var n=document.activeElement;if(void 0!==document.selection){n.focus();var i=document.selection.createRange();e=i.text}else if(void 0!==n.selectionStart){var o=n.selectionStart;e=n.value.substring(0,o)}}else{var r=window.getSelection().anchorNode;if(null!=r){var a=r.textContent,c=window.getSelection().getRangeAt(0).startOffset;c>=0&&(e=a.substring(0,c))}}return e}function d(e){var t,n,i="﻿",o="&#xfeff;",r="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2);if(document.selection&&document.selection.createRange)n=document.selection.createRange().duplicate(),n.selectStartOffset(e),n.selectEndOffset(e),n.collapse(!1),n.pasteHTML('<span id="'+r+'" style="position: relative;">'+o+"</span>"),t=document.getElementById(r);else if(window.getSelection){var a=window.getSelection();n=document.createRange(),n.setStart(a.anchorNode,e),n.setEnd(a.anchorNode,e),n.collapse(!1),t=document.createElement("span"),t.id=r,t.appendChild(document.createTextNode(i)),n.insertNode(t)}var c=t,l={left:0,top:t.offsetHeight};do l.left+=c.offsetLeft,l.top+=c.offsetTop;while(c=c.offsetParent);return t.parentNode.removeChild(t),l}function u(e,t){var n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],i=null!==window.mozInnerScreenX,o=document.createElement("div");o.id="input-textarea-caret-position-mirror-div",document.body.appendChild(o);var r=o.style,a=window.getComputedStyle?getComputedStyle(e):e.currentStyle;r.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(r.wordWrap="break-word"),r.position="absolute",r.visibility="hidden",n.forEach(function(e){r[e]=a[e]}),i?(r.width=parseInt(a.width)-2+"px",e.scrollHeight>parseInt(a.height)&&(r.overflowY="scroll")):r.overflow="hidden",o.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(o.textContent=o.textContent.replace(/\s/g," "));var c=document.createElement("span");c.textContent=e.value.substring(t)||".",o.appendChild(c);var l={top:c.offsetTop+parseInt(a.borderTopWidth)+c.offsetHeight,left:c.offsetLeft+parseInt(a.borderLeftWidth)},s=e;do l.left+=s.offsetLeft,l.top+=s.offsetTop;while(s=s.offsetParent);return document.body.removeChild(o),l}return{popUnderMention:e,replaceMacroText:r,replaceTriggerText:a,getMacroMatch:l,getTriggerInfo:s,selectElement:n}}),angular.module("mentio").run(["$templateCache",function(e){e.put("mentio-menu.tpl.html",'<ul class="dropdown-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:triggerText:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);